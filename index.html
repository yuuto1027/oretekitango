<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿ºçš„è‹±å˜èªã‚¢ãƒ—ãƒª</title>
    <script>
      tailwind.config = {
        darkMode: ['class', '.dark-mode'],
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
        body.dark-mode {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        }
        .dark-mode .bg-white {
            background-color: #2d3748 !important;
        }
        .dark-mode .text-gray-800 {
            color: #e2e8f0 !important;
        }
        .dark-mode .text-gray-600 {
            color: #cbd5e0 !important;
        }
        .dark-mode .text-gray-500 {
            color: #a0aec0 !important;
        }
        .dark-mode .border-gray-200 {
            border-color: #4a5568 !important;
        }
        .dark-mode .border-gray-300 {
            border-color: #4a5568 !important;
        }
        .dark-mode .bg-gray-50 {
            background-color: #374151 !important;
        }
        .dark-mode .bg-blue-50 {
            background-color: #1e3a5f !important;
        }
        .dark-mode .bg-red-50 {
            background-color: #5f1e1e !important;
        }
        .dark-mode .border-blue-200 {
            border-color: #2563eb !important;
        }
        .dark-mode .border-red-200 {
            border-color: #dc2626 !important;
        }
        
        /* å˜èªã‚«ãƒ¼ãƒ‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .flashcard {
            perspective: 1000px;
            cursor: pointer;
        }
        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flashcard-inner.flipped {
            transform: rotateY(180deg);
        }
        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 1rem;
            padding: 2rem;
        }
        .flashcard-back {
            transform: rotateY(180deg);
        }
        
        /* ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .side-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 80%;
            max-width: 300px;
            height: 100vh;
            background: white;
            transition: left 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        .side-menu.open {
            left: 0;
        }
        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 999;
        }
        .side-menu-overlay.open {
            opacity: 1;
            pointer-events: all;
        }
        .dark-mode .side-menu {
            background: #2d3748;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-purple-50 min-h-screen transition-colors duration-300">
    <div class="container mx-auto px-4 sm:px-6 py-4 sm:py-8 max-w-2xl">
        <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
        <div id="title-screen" class="fade-in">
            <!-- è¨­å®šãƒœã‚¿ãƒ³ -->
            <div class="flex justify-end mb-4">
                <button onclick="openSettingsMenu()" id="settings-btn" class="bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-600 rounded-full p-3 shadow-lg hover:shadow-xl transition-all">
                    <span class="text-2xl">âš™ï¸</span>
                </button>
            </div>
            
            <div class="text-center py-6 sm:py-12">
                <div class="mb-6 sm:mb-8">
                    <div class="inline-block gradient-bg text-white px-4 sm:px-8 py-2 sm:py-3 rounded-full text-xs sm:text-sm font-semibold mb-4 sm:mb-6 shadow-lg">
                        âœ¨ VOCABULARY MASTER
                    </div>
                    <h1 class="text-3xl sm:text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 mb-3 sm:mb-4 px-2">
                        ä¿ºçš„è‹±å˜èªã‚¢ãƒ—ãƒª
                    </h1>
                    <p class="text-gray-600 text-sm sm:text-base md:text-lg px-4">ã‚ãªãŸã ã‘ã®è‹±å˜èªå­¦ç¿’ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </p>
                </div>
                
                <div class="space-y-4 sm:space-y-6 max-w-md mx-auto mt-8 sm:mt-12">
                    <button onclick="goToQuizMenu()" class="card-hover w-full bg-white border-2 border-indigo-200 hover:border-indigo-400 text-gray-800 font-bold py-4 sm:py-6 px-6 sm:px-8 rounded-2xl text-lg sm:text-xl shadow-xl">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="text-2xl sm:text-3xl mr-3 sm:mr-4">ğŸ“š</span>
                                <span>å•é¡Œã‚’è§£ã</span>
                            </div>
                            <span class="text-indigo-600">â†’</span>
                        </div>
                    </button>
                    
                    <button onclick="goToFlashcardMenu()" class="card-hover w-full bg-white border-2 border-purple-200 hover:border-purple-400 text-gray-800 font-bold py-4 sm:py-6 px-6 sm:px-8 rounded-2xl text-lg sm:text-xl shadow-xl">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="text-2xl sm:text-3xl mr-3 sm:mr-4">ğŸ´</span>
                                <span>å˜èªã‚«ãƒ¼ãƒ‰</span>
                            </div>
                            <span class="text-purple-600">â†’</span>
                        </div>
                    </button>
                    
                    <button onclick="goToCreateDeck()" class="card-hover w-full bg-white border-2 border-green-200 hover:border-green-400 text-gray-800 font-bold py-4 sm:py-6 px-6 sm:px-8 rounded-2xl text-lg sm:text-xl shadow-xl">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="text-2xl sm:text-3xl mr-3 sm:mr-4">â•</span>
                                <span>å˜èªã‚’è¿½åŠ ã™ã‚‹</span>
                            </div>
                            <span class="text-green-600">â†’</span>
                        </div>
                    </button>
                </div>
                
                <div class="mt-12 text-gray-500 text-sm">
                    <p id="total-words-count">ç™»éŒ²å˜èªæ•°: 0èª</p>
                </div>
            </div>
        </div>

        <!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
        <div id="quiz-screen" class="hidden">
            <div class="mb-4 sm:mb-6">
                <div class="flex justify-between items-center">
                    <button onclick="quitQuiz()" class="text-gray-600 hover:text-gray-800 text-sm sm:text-base">â† ä¸­æ–­ã—ã¦æˆ»ã‚‹</button>
                    <span id="quiz-progress-text" class="text-sm sm:text-lg text-gray-600">å•é¡Œ <span id="current-question">1</span> / 20</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-4">
                    <div id="progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 5%"></div>
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg p-6 sm:p-8 mb-4 sm:mb-6 border border-gray-200">
                <p class="text-xs sm:text-sm text-gray-500 mb-2">ã“ã®è‹±èªã®æ„å‘³ã‚’é¸ã‚“ã§ãã ã•ã„</p>
                <div class="flex items-center justify-center space-x-4">
                    <h2 id="question-word" class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-800 text-center break-words"></h2>
                    <button onclick="speak(document.getElementById('question-word').textContent)" class="text-2xl sm:text-3xl text-gray-500 hover:text-indigo-600 transition-colors">ğŸ”Š</button>
                </div>
            </div>

            <div id="options-container" class="space-y-2 sm:space-y-3">
                <!-- é¸æŠè‚¢ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>

        <!-- çµæœç”»é¢ -->
        <div id="result-screen" class="hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">ã‚¯ã‚¤ã‚ºçµæœ</h1>
            
            <!-- å††ã‚°ãƒ©ãƒ• -->
            <div class="flex justify-center mb-6">
                <div class="relative w-48 h-48">
                    <svg viewBox="0 0 200 200" class="transform -rotate-90">
                        <circle cx="100" cy="100" r="80" fill="none" stroke="#fee2e2" stroke-width="40"/>
                        <circle id="result-circle" cx="100" cy="100" r="80" fill="none" stroke="#22c55e" stroke-width="40" 
                                stroke-dasharray="0 502.4" stroke-linecap="round"/>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <p class="text-4xl font-bold text-gray-800" id="score-percentage"></p>
                        <p class="text-sm text-gray-600">æ­£ç­”ç‡</p>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 rounded-lg p-6 mb-6 border border-blue-200">
                <div class="flex justify-around text-center">
                    <div>
                        <p class="text-3xl font-bold text-green-600" id="correct-count"></p>
                        <p class="text-sm text-gray-600">æ­£è§£</p>
                    </div>
                    <div>
                        <p class="text-3xl font-bold text-red-600" id="incorrect-count"></p>
                        <p class="text-sm text-gray-600">ä¸æ­£è§£</p>
                    </div>
                </div>
            </div>

            <div id="mistakes-container" class="mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">é–“é•ãˆãŸå•é¡Œ</h2>
                <div id="mistakes-list" class="space-y-3">
                    <!-- é–“é•ãˆãŸå•é¡ŒãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>

            <button onclick="restartQuiz()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-4">
                ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹
            </button>
            <button onclick="restartWithMistakes()" id="restart-mistakes-button" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition-colors mb-4 hidden">
                é–“é•ãˆãŸå•é¡Œã ã‘å¾©ç¿’ã™ã‚‹
            </button>
            <button onclick="backToTitle()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg transition-colors">
                ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹
            </button>
        </div>

        <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
        <div id="start-screen" class="hidden">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-gray-800 mb-4">è‹±å˜èªã‚¯ã‚¤ã‚º</h1>
                <p class="text-gray-600 mb-8">20å•ã®è‹±å˜èªã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼<br>è‹±èªã‚’è¦‹ã¦ã€æ­£ã—ã„æ—¥æœ¬èªã®æ„å‘³ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
                <button onclick="startQuiz()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-lg text-xl transition-colors">
                    ã‚¯ã‚¤ã‚ºã‚’å§‹ã‚ã‚‹
                </button>
                <button onclick="backToTitle()" class="mt-4 text-gray-600 hover:text-gray-800 underline">
                    ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹
                </button>
            </div>
        </div>

        <!-- ã‚¯ã‚¤ã‚ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ -->
        <div id="quiz-menu-screen" class="hidden">
            <div class="mb-4 sm:mb-6">
                <button onclick="backToTitle()" class="text-gray-600 hover:text-gray-800 mb-3 sm:mb-4 text-sm sm:text-base">â† ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">å•é¡Œã‚’é¸ã¶</h1>
                <p class="text-sm sm:text-base text-gray-600">å­¦ç¿’ã—ãŸã„å•é¡Œã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„</p>
            </div>
            
            <div id="deck-list" class="space-y-3 sm:space-y-4">
                <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒƒã‚­ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>
        </div>

        <!-- ãƒ‡ãƒƒã‚­è©³ç´°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ -->
        <div id="deck-menu-detail-screen" class="hidden">
            <div class="mb-4 sm:mb-6">
                <button onclick="goToQuizMenu()" class="text-gray-600 hover:text-gray-800 mb-3 sm:mb-4 text-sm sm:text-base">â† å•é¡Œã‚’é¸ã¶ã«æˆ»ã‚‹</button>
                <h1 id="deck-menu-name" class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2"></h1>
                <p class="text-sm sm:text-base text-gray-600">ãƒ‡ãƒƒã‚­æƒ…å ±ã¨å­¦ç¿’é–‹å§‹</p>
            </div>
            
            <div class="mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">è‹¦æ‰‹ãªå˜èª Top 5</h2>
                <div id="high-priority-words" class="space-y-3">
                    <!-- è‹¦æ‰‹ãªå˜èªãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
            
            <button id="start-quiz-from-menu-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-lg text-xl transition-colors shadow-lg">
                ã“ã®ãƒ‡ãƒƒã‚­ã§å•é¡Œã‚’å§‹ã‚ã‚‹
            </button>
        </div>

        <!-- å˜èªè¿½åŠ ç”»é¢ï¼ˆãƒ‡ãƒƒã‚­ç®¡ç†ï¼‰ -->
        <div id="create-deck-screen" class="hidden">
            <div class="mb-4 sm:mb-6">
                <button onclick="backToTitle()" class="text-gray-600 hover:text-gray-800 mb-3 sm:mb-4 text-sm sm:text-base">â† ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">å˜èªãƒ‡ãƒƒã‚­ç®¡ç†</h1>
                <p class="text-sm sm:text-base text-gray-600">ãƒ‡ãƒƒã‚­ã®ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãŒã§ãã¾ã™</p>
            </div>

            <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
            <div class="flex mb-6 border-b-2 border-gray-200">
                <button id="deck-list-tab" onclick="switchTab('list')" class="flex-1 py-3 font-bold text-indigo-600 border-b-2 border-indigo-600 transition-colors">
                    ãƒ‡ãƒƒã‚­ä¸€è¦§
                </button>
                <button id="deck-create-tab" onclick="switchTab('create')" class="flex-1 py-3 font-bold text-gray-400 border-b-2 border-transparent transition-colors">
                    æ–°è¦ä½œæˆ
                </button>
            </div>

            <!-- ãƒ‡ãƒƒã‚­ä¸€è¦§ã‚¿ãƒ– -->
            <div id="deck-list-content" class="space-y-4">
                <div id="deck-management-list">
                    <!-- ãƒ‡ãƒƒã‚­ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>

            <!-- æ–°è¦ä½œæˆã‚¿ãƒ– -->
            <div id="deck-create-content" class="hidden">
                <div class="bg-white border-2 border-gray-200 rounded-2xl p-4 sm:p-6 shadow-lg mb-4 sm:mb-6">
                    <div class="mb-4 sm:mb-6">
                        <label class="block text-gray-700 font-bold mb-2 text-sm sm:text-base">ãƒ‡ãƒƒã‚­å</label>
                        <input type="text" id="deck-name" class="w-full px-3 sm:px-4 py-2 sm:py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 text-sm sm:text-base" placeholder="ä¾‹: TOEICé »å‡ºå˜èª">
                    </div>

                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800 text-sm sm:text-base">å˜èªãƒªã‚¹ãƒˆ</h3>
                            <input type="text" id="deck-word-search" class="px-3 py-1 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 text-sm" placeholder="å˜èªã‚’æ¤œç´¢...">
                        </div>
                        <div id="deck-words-list" class="space-y-2 mb-4 max-h-48 sm:max-h-60 overflow-y-auto">
                            <!-- è¿½åŠ ã•ã‚ŒãŸå˜èªãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </div>
                    </div>

                    <div class="border-t-2 border-gray-200 pt-4">
                        <h4 class="font-semibold text-gray-700 mb-3 text-sm sm:text-base">å˜èªã‚’è¿½åŠ </h4>
                        <div class="mb-3">
                            <input type="text" id="word-english" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 mb-2 text-sm sm:text-base" placeholder="è‹±å˜èª">
                            <input type="text" id="word-japanese" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 text-sm sm:text-base" placeholder="æ—¥æœ¬èªã®æ„å‘³">
                        </div>
                        <button onclick="addWordToDeck()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm sm:text-base">
                            + å˜èªã‚’è¿½åŠ 
                        </button>
                    </div>
                </div>

                <button onclick="saveDeck()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 sm:py-4 px-4 sm:px-6 rounded-lg transition-colors shadow-lg mb-3 text-sm sm:text-base">
                    ğŸ’¾ ãƒ‡ãƒƒã‚­ã‚’ä¿å­˜
                </button>
            </div>
        </div>

        <!-- å˜èªã‚«ãƒ¼ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ -->
        <div id="flashcard-menu-screen" class="hidden">
            <div class="mb-4 sm:mb-6">
                <button onclick="backToTitle()" class="text-gray-600 hover:text-gray-800 mb-3 sm:mb-4 text-sm sm:text-base">â† ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">å˜èªã‚«ãƒ¼ãƒ‰ã‚’é¸ã¶</h1>
                <p class="text-sm sm:text-base text-gray-600">å¾©ç¿’ã—ãŸã„å˜èªã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„</p>
            </div>
            
            <div id="flashcard-deck-list" class="space-y-3 sm:space-y-4">
                <!-- ãƒ‡ãƒƒã‚­ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>
        </div>

        <!-- å˜èªã‚«ãƒ¼ãƒ‰è¡¨ç¤ºç”»é¢ -->
        <div id="flashcard-screen" class="hidden">
            <!-- ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
            <div id="side-menu-overlay" class="side-menu-overlay" onclick="closeSideMenu()"></div>
            
            <!-- ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
            <div id="side-menu" class="side-menu">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">å˜èªã‚’é¸æŠ</h2>
                        <button onclick="closeSideMenu()" class="text-gray-600 hover:text-gray-800 text-2xl">Ã—</button>
                    </div>
                    <div id="word-selection-list" class="space-y-2">
                        <!-- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
            </div>

            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="flex justify-between items-center mb-6">
                <button onclick="backToFlashcardMenu()" class="text-gray-600 hover:text-gray-800 text-sm sm:text-base">â† æˆ»ã‚‹</button>
                <div class="flex items-center space-x-4">
                    <span class="text-sm sm:text-base text-gray-600" id="flashcard-progress">1 / 10</span>
                    <button onclick="openSideMenu()" class="bg-white border-2 border-gray-200 rounded-lg px-3 py-2 hover:border-gray-400 transition-all">
                        âš™ï¸ è¨­å®š
                    </button>
                </div>
            </div>

            <!-- å˜èªã‚«ãƒ¼ãƒ‰ -->
            <div class="flashcard mb-6" style="height: 400px;">
                <div id="flashcard-inner" class="flashcard-inner">
                    <div class="flashcard-front bg-gradient-to-br from-indigo-500 to-purple-600 shadow-2xl">
                        <div class="relative w-full h-full flex items-center justify-center">
                            <h2 id="flashcard-english" class="text-4xl sm:text-5xl font-bold text-white text-center break-words px-12"></h2>
                            <button onclick="event.stopPropagation(); speak(document.getElementById('flashcard-english').textContent)" class="absolute bottom-4 right-4 text-3xl text-white opacity-70 hover:opacity-100 transition-opacity">ğŸ”Š</button>
                        </div>
                    </div>
                    <div class="flashcard-back bg-gradient-to-br from-green-500 to-teal-600 shadow-2xl">
                        <h2 id="flashcard-japanese" class="text-3xl sm:text-4xl font-bold text-white text-center break-words"></h2>
                    </div>
                </div>
            </div>

            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
            <div class="grid grid-cols-3 gap-4">
                <button onclick="previousFlashcard()" class="bg-white border-2 border-gray-300 hover:border-indigo-400 text-gray-800 font-bold py-4 px-6 rounded-lg transition-all">
                    â† å‰ã¸
                </button>
                <button onclick="flipFlashcard()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg transition-all">
                    è£è¿”ã™
                </button>
                <button onclick="nextFlashcard()" class="bg-white border-2 border-gray-300 hover:border-indigo-400 text-gray-800 font-bold py-4 px-6 rounded-lg transition-all">
                    æ¬¡ã¸ â†’
                </button>
            </div>
        </div>

        <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="settings-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="closeSettingsMenu()"></div>
        <div id="settings-menu" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 z-50 hidden transform scale-95 opacity-0 transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">è¨­å®š</h2>
                <button onclick="closeSettingsMenu()" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>

            <div class="space-y-4">
                <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <div class="flex items-center">
                        <span id="dark-mode-icon-in-settings" class="text-2xl mr-3"></span>
                        <span class="font-semibold text-gray-800">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="dark-mode-toggle-checkbox" onchange="toggleDarkMode()" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500 peer-checked:bg-blue-600"></div>
                    </label>
                </div>

                <button onclick="confirmDeleteAllData()" class="w-full flex items-center justify-center bg-red-100 dark:bg-red-800 text-red-600 dark:text-red-200 font-bold py-3 px-4 rounded-lg hover:bg-red-200 dark:hover:bg-red-700 transition-colors">
                    <span class="text-xl mr-2">ğŸ—‘ï¸</span>
                    å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                </button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_PRIORITY = 10;
        let customDecks = JSON.parse(localStorage.getItem('customDecks') || '[]');
        
        // Migrate old data to include priority
        customDecks.forEach(deck => {
            deck.words.forEach(word => {
                if (word.priority === undefined) {
                    word.priority = DEFAULT_PRIORITY;
                }
            });
        });

        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let allQuizWords = [];
        let lastPlayedDeckId = -1;

        function startQuiz() {
            // This function is not reachable from the UI.
        }

        function showQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) return;
            const question = quizQuestions[currentQuestionIndex];
            const totalQuestions = quizQuestions.length;

            document.getElementById('current-question').textContent = currentQuestionIndex + 1;
            document.getElementById('question-word').textContent = question.english;
            document.getElementById('progress-bar').style.width = ((currentQuestionIndex + 1) / totalQuestions * 100) + '%';
            document.getElementById('quiz-progress-text').innerHTML = `å•é¡Œ <span id="current-question">${currentQuestionIndex + 1}</span> / ${totalQuestions}`;


            // Generate options (1 correct + 3 incorrect)
            const options = [question.japanese];
            const otherWords = allQuizWords.filter(w => w.japanese !== question.japanese);
            
            const incorrectOptions = new Set();
            while (incorrectOptions.size < 3 && otherWords.length > 0) {
                const randomWord = otherWords[Math.floor(Math.random() * otherWords.length)];
                if (!options.includes(randomWord.japanese)) {
                    incorrectOptions.add(randomWord.japanese);
                }
                if (options.length + incorrectOptions.size >= allQuizWords.length) break;
            }
            options.push(...incorrectOptions);
            options.sort(() => Math.random() - 0.5);

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'w-full text-left p-4 rounded-lg border-2 border-gray-300 hover:border-blue-400 hover:bg-blue-50 transition-all';
                button.textContent = option;
                button.onclick = () => selectAnswer(option, button);
                container.appendChild(button);
            });

            selectedAnswer = null;
        }

        let selectedAnswer = null;

        function selectAnswer(answer, button) {
            if (selectedAnswer !== null) return;

            selectedAnswer = answer;
            const question = quizQuestions[currentQuestionIndex];
            const isCorrect = answer === question.japanese;

            userAnswers.push({
                question: question,
                userAnswer: answer,
                isCorrect: isCorrect
            });

            const allButtons = document.querySelectorAll('#options-container button');
            
            allButtons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === question.japanese) {
                    btn.classList.remove('border-gray-300', 'hover:border-blue-400', 'hover:bg-blue-50');
                    btn.classList.add('border-green-500', 'bg-green-100');
                }
                else if (btn === button && !isCorrect) {
                    btn.classList.remove('border-gray-300', 'hover:border-blue-400', 'hover:bg-blue-50');
                    btn.classList.add('border-red-500', 'bg-red-100');
                }
            });

            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < quizQuestions.length) {
                    showQuestion();
                } else {
                    showResults();
                }
            }, 1500);
        }

        function showResults() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');

            const totalQuestions = quizQuestions.length;
            const correctAnswers = userAnswers.filter(a => a.isCorrect).length;
            const incorrectAnswers = totalQuestions - correctAnswers;
            const percentage = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;

            document.getElementById('score-percentage').textContent = percentage + '%';
            document.getElementById('correct-count').textContent = correctAnswers;
            document.getElementById('incorrect-count').textContent = incorrectAnswers;

            if (lastPlayedDeckId !== -1) {
                const deck = customDecks[lastPlayedDeckId];
                userAnswers.forEach(answer => {
                    const wordToUpdate = deck.words.find(w => w.english === answer.question.english && w.japanese === answer.question.japanese);
                    if (wordToUpdate) {
                        if (answer.isCorrect) {
                            wordToUpdate.priority = Math.max(1, wordToUpdate.priority - 1);
                        } else {
                            wordToUpdate.priority += 2; // Increase more for incorrect answers
                        }
                    }
                });
                localStorage.setItem('customDecks', JSON.stringify(customDecks));
            }

            const circumference = 2 * Math.PI * 80;
            const offset = circumference - (percentage / 100) * circumference;
            const circle = document.getElementById('result-circle');
            
            setTimeout(() => {
                circle.style.strokeDasharray = `${circumference} ${circumference}`;
                circle.style.strokeDashoffset = offset;
                circle.style.transition = 'stroke-dashoffset 1s ease-out';
            }, 100);

            const mistakesList = document.getElementById('mistakes-list');
            const mistakes = userAnswers.filter(a => !a.isCorrect);
            const restartMistakesButton = document.getElementById('restart-mistakes-button');

            if (mistakes.length === 0) {
                mistakesList.innerHTML = '<p class="text-green-600 font-bold text-center py-4">å…¨å•æ­£è§£ã§ã™ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ğŸ‰</p>';
                restartMistakesButton.classList.add('hidden');
            } else {
                restartMistakesButton.classList.remove('hidden');
                mistakesList.innerHTML = '';
                mistakes.forEach(mistake => {
                    const div = document.createElement('div');
                    div.className = 'bg-red-50 border border-red-200 rounded-lg p-4';
                    div.innerHTML = `
                        <div class="font-bold text-gray-800 mb-1">${mistake.question.english}</div>
                        <div class="text-sm text-gray-600">
                            <span class="text-green-600">æ­£è§£: ${mistake.question.japanese}</span><br>
                            <span class="text-red-600">ã‚ãªãŸã®è§£ç­”: ${mistake.userAnswer}</span>
                        </div>
                    `;
                    mistakesList.appendChild(div);
                });
            }
        }

        function restartWithMistakes() {
            const mistakes = userAnswers.filter(a => !a.isCorrect).map(a => a.question);
            if (mistakes.length === 0) return;
            
            quizQuestions = [...mistakes].sort(() => Math.random() - 0.5);
            currentQuestionIndex = 0;
            userAnswers = [];

            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            
            showQuestion();
        }

        function restartQuiz() {
            if (lastPlayedDeckId !== -1) {
                document.getElementById('result-screen').classList.add('hidden');
                goToDeckMenu(lastPlayedDeckId);
            } else {
                backToTitle();
            }
        }

        function backToTitle() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-menu-screen').classList.add('hidden');
            document.getElementById('create-deck-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('flashcard-menu-screen').classList.add('hidden');
            document.getElementById('flashcard-screen').classList.add('hidden');
            document.getElementById('deck-menu-detail-screen').classList.add('hidden');
            document.getElementById('title-screen').classList.remove('hidden');
            updateTotalWordsCount();
        }

        let currentDeckWords = [];
        let editingDeckIndex = -1;
        let isEditingMode = false;

        function goToQuizMenu() {
            document.getElementById('title-screen').classList.add('hidden');
            document.getElementById('deck-menu-detail-screen').classList.add('hidden');
            document.getElementById('quiz-menu-screen').classList.remove('hidden');
            renderDeckList();
        }

        function goToDeckMenu(deckId) {
            document.getElementById('quiz-menu-screen').classList.add('hidden');
            document.getElementById('deck-menu-detail-screen').classList.remove('hidden');

            const deck = customDecks[deckId];
            document.getElementById('deck-menu-name').textContent = `ğŸ“ ${deck.name}`;
            
            const startBtn = document.getElementById('start-quiz-from-menu-btn');
            startBtn.onclick = () => startQuizFromDeck(deckId);

            const highPriorityWordsContainer = document.getElementById('high-priority-words');
            highPriorityWordsContainer.innerHTML = '';
            
            const sortedWords = [...deck.words].sort((a, b) => b.priority - a.priority);
            const topWords = sortedWords.filter(w => w.priority > DEFAULT_PRIORITY).slice(0, 5);
            
            if (topWords.length === 0) {
                highPriorityWordsContainer.innerHTML = '<p class="text-gray-400 text-center py-4">ç´ æ™´ã‚‰ã—ã„ï¼ç‰¹ã«è‹¦æ‰‹ãªå˜èªã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            } else {
                 topWords.forEach(word => {
                    const wordDiv = document.createElement('div');
                    wordDiv.className = 'bg-orange-50 border border-orange-200 rounded-lg p-3';
                    const priorityBar = `
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2 mt-2">
                            <div class="bg-orange-400 h-2 rounded-full" style="width: ${Math.min(100, (word.priority / 20) * 100)}%"></div>
                        </div>
                    `;

                    wordDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-bold text-gray-800">${word.english}</div>
                                <div class="text-sm text-gray-600">${word.japanese}</div>
                            </div>
                            <div class="text-xs text-orange-600 font-semibold">
                                è‹¦æ‰‹åº¦: ${word.priority}
                            </div>
                        </div>
                        ${priorityBar}
                    `;
                    highPriorityWordsContainer.appendChild(wordDiv);
                 });
            }
        }

        function goToCreateDeck() {
            isEditingMode = false;
            document.getElementById('title-screen').classList.add('hidden');
            document.getElementById('create-deck-screen').classList.remove('hidden');
            switchTab('list');
            renderDeckManagementList();
        }

        function switchTab(tab) {
            const listTab = document.getElementById('deck-list-tab');
            const createTab = document.getElementById('deck-create-tab');
            const listContent = document.getElementById('deck-list-content');
            const createContent = document.getElementById('deck-create-content');

            if (tab === 'list') {
                listTab.classList.add('text-indigo-600', 'border-indigo-600');
                listTab.classList.remove('text-gray-400', 'border-transparent');
                createTab.classList.add('text-gray-400', 'border-transparent');
                createTab.classList.remove('text-indigo-600', 'border-indigo-600');
                listContent.classList.remove('hidden');
                createContent.classList.add('hidden');
                createTab.textContent = 'æ–°è¦ä½œæˆ';
                renderDeckManagementList();
            } else {
                createTab.classList.add('text-indigo-600', 'border-indigo-600');
                createTab.classList.remove('text-gray-400', 'border-transparent');
                listTab.classList.add('text-gray-400', 'border-transparent');
                listTab.classList.remove('text-indigo-600', 'border-indigo-600');
                createContent.classList.remove('hidden');
                listContent.classList.add('hidden');
                
                if (isEditingMode) {
                    createTab.textContent = 'ãƒ‡ãƒƒã‚­ç·¨é›†';
                } else {
                    createTab.textContent = 'æ–°è¦ä½œæˆ';
                    editingDeckIndex = -1;
                    currentDeckWords = [];
                    document.getElementById('deck-name').value = '';
                    document.getElementById('word-english').value = '';
                    document.getElementById('word-japanese').value = '';
                }
                document.getElementById('deck-word-search').value = '';
                renderDeckWordsList();
                
                const searchInput = document.getElementById('deck-word-search');
                searchInput.oninput = () => {
                    renderDeckWordsList(searchInput.value);
                };
            }
        }

        function renderDeckManagementList() {
            const listContainer = document.getElementById('deck-management-list');
            listContainer.innerHTML = '';
            if (customDecks.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-400 text-center py-8">ã¾ã ãƒ‡ãƒƒã‚­ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“<br><span class="text-sm">ã€Œæ–°è¦ä½œæˆã€ã‚¿ãƒ–ã‹ã‚‰æ–°ã—ã„ãƒ‡ãƒƒã‚­ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</span></p>';
                return;
            }

            customDecks.forEach((deck, index) => {
                const deckCard = document.createElement('div');
                deckCard.className = 'bg-white border-2 border-gray-200 rounded-2xl p-4 sm:p-6 shadow-lg';
                deckCard.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-1">ğŸ“š ${deck.name}</h3>
                            <p class="text-xs sm:text-sm text-gray-600">${deck.words.length}èª</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editDeck(${index})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                âœï¸ ç·¨é›†
                            </button>
                            <button onclick="deleteDeckFromManagement(${index})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                ğŸ—‘ï¸ å‰Šé™¤
                            </button>
                        </div>
                    </div>
                `;
                listContainer.appendChild(deckCard);
            });
        }

        function editDeck(index) {
            isEditingMode = true;
            editingDeckIndex = index;
            const deck = customDecks[index];
            currentDeckWords = deck.words.map(word => ({ ...word }));
            document.getElementById('deck-name').value = deck.name;
            switchTab('create');
        }

        function deleteDeckFromManagement(index) {
            if (confirm('ã“ã®ãƒ‡ãƒƒã‚­ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nå˜èªã‚«ãƒ¼ãƒ‰ã®è¨­å®šã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
                localStorage.removeItem(`wordVisibility_${index}`);
                customDecks.splice(index, 1);
                localStorage.setItem('customDecks', JSON.stringify(customDecks));
                renderDeckManagementList();
                updateTotalWordsCount();
            }
        }

        function renderDeckList() {
            const deckListContainer = document.getElementById('deck-list');
            deckListContainer.innerHTML = '';

            if (customDecks.length === 0) {
                deckListContainer.innerHTML = '<p class="text-gray-400 text-center py-8">ã¾ã å•é¡Œã‚«ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“<br><span class="text-sm">ã€Œå˜èªã‚’è¿½åŠ ã™ã‚‹ã€ã‹ã‚‰æ–°ã—ã„ãƒ‡ãƒƒã‚­ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</span></p>';
                return;
            }

            customDecks.forEach((deck, index) => {
                const deckCard = document.createElement('div');
                deckCard.className = 'card-hover bg-white border-2 border-green-200 rounded-2xl p-6 shadow-lg cursor-pointer';
                deckCard.onclick = () => goToDeckMenu(index);
                deckCard.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-1">ğŸ“ ${deck.name}</h3>
                            <p class="text-sm text-gray-600">ã‚«ã‚¹ã‚¿ãƒ å˜èªå¸³</p>
                        </div>
                        <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-semibold">${deck.words.length}èª</span>
                    </div>
                    <div class="text-indigo-600 font-semibold text-sm">ãƒ‡ãƒƒã‚­ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã â†’</div>
                `;
                deckListContainer.appendChild(deckCard);
            });
        }

        function addWordToDeck() {
            const english = document.getElementById('word-english').value.trim();
            const japanese = document.getElementById('word-japanese').value.trim();

            if (!english || !japanese) {
                alert('è‹±å˜èªã¨æ—¥æœ¬èªã®æ„å‘³ã‚’ä¸¡æ–¹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            currentDeckWords.push({ english, japanese, priority: DEFAULT_PRIORITY });
            document.getElementById('word-english').value = '';
            document.getElementById('word-japanese').value = '';
            document.getElementById('word-english').focus();
            renderDeckWordsList();
        }

        function renderDeckWordsList(searchTerm = '') {
            const listContainer = document.getElementById('deck-words-list');
            listContainer.innerHTML = '';
            
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const filteredWords = currentDeckWords.filter(word => 
                word.english.toLowerCase().includes(lowerCaseSearchTerm) ||
                word.japanese.toLowerCase().includes(lowerCaseSearchTerm)
            );

            if (filteredWords.length === 0) {
                if (searchTerm) {
                    listContainer.innerHTML = `<p class="text-gray-400 text-sm text-center py-4">ã€Œ${searchTerm}ã€ã«ä¸€è‡´ã™ã‚‹å˜èªã¯ã‚ã‚Šã¾ã›ã‚“</p>`;
                } else {
                    listContainer.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">ã¾ã å˜èªãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                }
                return;
            }

            filteredWords.forEach(word => {
                const originalIndex = currentDeckWords.findIndex(w => w.english === word.english && w.japanese === word.japanese);
                const wordDiv = document.createElement('div');
                wordDiv.className = 'flex items-center justify-between bg-gray-50 px-3 py-2 rounded-lg';
                wordDiv.innerHTML = `
                    <div>
                        <span class="font-semibold text-gray-800">${word.english}</span>
                        <span class="text-gray-600 text-sm ml-2">- ${word.japanese}</span>
                    </div>
                    <button onclick="removeWordFromDeck(${originalIndex})" class="text-red-500 hover:text-red-700 text-sm">âœ•</button>
                `;
                listContainer.appendChild(wordDiv);
            });
        }

        function removeWordFromDeck(index) {
            currentDeckWords.splice(index, 1);
            renderDeckWordsList();
        }

        function saveDeck() {
            const deckName = document.getElementById('deck-name').value.trim();

            if (!deckName) {
                alert('ãƒ‡ãƒƒã‚­åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (currentDeckWords.length < 4) {
                alert('æœ€ä½4ã¤ã®å˜èªã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼ˆã‚¯ã‚¤ã‚ºã«å¿…è¦ã§ã™ï¼‰ã€‚');
                return;
            }

            const newDeck = { name: deckName, words: currentDeckWords };

            if (editingDeckIndex >= 0) {
                customDecks[editingDeckIndex] = newDeck;
                alert(`ã€Œ${deckName}ã€ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼`);
                // Ensure new words are visible by default
                const visibility = JSON.parse(localStorage.getItem(`wordVisibility_${editingDeckIndex}`) || '{}');
                newDeck.words.forEach((_, i) => {
                    if(visibility[i] === undefined) visibility[i] = true;
                });
                localStorage.setItem(`wordVisibility_${editingDeckIndex}`, JSON.stringify(visibility));
            } else {
                customDecks.push(newDeck);
                const newDeckIndex = customDecks.length - 1;
                const visibility = {};
                newDeck.words.forEach((_, i) => {
                    visibility[i] = true;
                });
                localStorage.setItem(`wordVisibility_${newDeckIndex}`, JSON.stringify(visibility));
                alert(`ã€Œ${deckName}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`);
            }

            localStorage.setItem('customDecks', JSON.stringify(customDecks));
            editingDeckIndex = -1;
            isEditingMode = false;
            backToTitle();
        }

        function quitQuiz() {
            if (confirm('ã‚¯ã‚¤ã‚ºã‚’ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®é€²æ—ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚')) {
                document.getElementById('quiz-screen').classList.add('hidden');
                document.getElementById('quiz-menu-screen').classList.remove('hidden');
                quizQuestions = [];
                currentQuestionIndex = 0;
                userAnswers = [];
                allQuizWords = [];
                lastPlayedDeckId = -1;
            }
        }

        function startQuizFromDeck(deckId) {
            lastPlayedDeckId = deckId;
            const sourceWords = customDecks[deckId].words;

            if (sourceWords.length < 4) {
                alert('ã“ã®ãƒ‡ãƒƒã‚­ã«ã¯å˜èªãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆæœ€ä½4èªå¿…è¦ã§ã™ï¼‰ã€‚');
                return;
            }
            
            allQuizWords = [...sourceWords];
            const numQuestions = Math.min(20, sourceWords.length);

            const weightedPool = [];
            sourceWords.forEach(word => {
                for (let i = 0; i < (word.priority || DEFAULT_PRIORITY); i++) {
                    weightedPool.push(word);
                }
            });
            
            const shuffledPool = weightedPool.sort(() => Math.random() - 0.5);
            
            const uniqueQuestions = new Set();
            const finalQuestions = [];

            for (const word of shuffledPool) {
                if (finalQuestions.length >= numQuestions) break;
                if (!uniqueQuestions.has(word.english)) {
                    uniqueQuestions.add(word.english);
                    finalQuestions.push(word);
                }
            }
            
            if (finalQuestions.length < numQuestions) {
                 const remainingWords = sourceWords.filter(w => !uniqueQuestions.has(w.english));
                 remainingWords.sort(() => Math.random() - 0.5);
                 while(finalQuestions.length < numQuestions && remainingWords.length > 0) {
                     finalQuestions.push(remainingWords.pop());
                 }
            }
            
            quizQuestions = finalQuestions;
            currentQuestionIndex = 0;
            userAnswers = [];

            document.getElementById('deck-menu-detail-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            
            showQuestion();
        }

        function updateTotalWordsCount() {
            const totalWords = customDecks.reduce((sum, deck) => sum + deck.words.length, 0);
            document.getElementById('total-words-count').textContent = `ç™»éŒ²å˜èªæ•°: ${totalWords}èª`;
        }

        function toggleDarkMode() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
            updateDarkModeUI();
        }

        function updateDarkModeUI() {
            const isDarkMode = localStorage.getItem('darkMode') === 'enabled';
            const body = document.body;
            const iconInSettings = document.getElementById('dark-mode-icon-in-settings');
            const toggleCheckbox = document.getElementById('dark-mode-toggle-checkbox');

            if (isDarkMode) {
                body.classList.add('dark-mode');
                if(iconInSettings) iconInSettings.textContent = 'â˜€ï¸';
                if(toggleCheckbox) toggleCheckbox.checked = true;
            } else {
                body.classList.remove('dark-mode');
                if(iconInSettings) iconInSettings.textContent = 'ğŸŒ™';
                if(toggleCheckbox) toggleCheckbox.checked = false;
            }
        }

        function openSettingsMenu() {
            const settingsMenu = document.getElementById('settings-menu');
            const settingsOverlay = document.getElementById('settings-overlay');
            settingsMenu.classList.remove('hidden');
            settingsOverlay.classList.remove('hidden');
            setTimeout(() => {
                settingsMenu.classList.remove('scale-95', 'opacity-0');
            }, 10);
            updateDarkModeUI();
        }

        function closeSettingsMenu() {
            const settingsMenu = document.getElementById('settings-menu');
            const settingsOverlay = document.getElementById('settings-overlay');
            settingsMenu.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                settingsMenu.classList.add('hidden');
                settingsOverlay.classList.add('hidden');
            }, 200);
        }

        function confirmDeleteAllData() {
            if (confirm('æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                localStorage.clear();
                customDecks = [];
                alert('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚');
                location.reload();
            }
        }

        window.addEventListener('load', () => {
            updateTotalWordsCount();
            updateDarkModeUI();
        });

        let currentFlashcardDeckId = null;
        let flashcardList = [];
        let currentFlashcardIndex = 0;
        let wordVisibility = {};

        function goToFlashcardMenu() {
            document.getElementById('title-screen').classList.add('hidden');
            document.getElementById('flashcard-menu-screen').classList.remove('hidden');
            renderFlashcardDeckList();
        }

        function renderFlashcardDeckList() {
            const deckListContainer = document.getElementById('flashcard-deck-list');
            deckListContainer.innerHTML = '';

            if (customDecks.length === 0) {
                deckListContainer.innerHTML = '<p class="text-gray-400 text-center py-8">ã¾ã å˜èªã‚«ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“<br><span class="text-sm">ã€Œå˜èªã‚’è¿½åŠ ã™ã‚‹ã€ã‹ã‚‰æ–°ã—ã„ãƒ‡ãƒƒã‚­ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</span></p>';
                return;
            }

            customDecks.forEach((deck, index) => {
                const deckCard = document.createElement('div');
                deckCard.className = 'card-hover bg-white border-2 border-purple-200 rounded-2xl p-6 shadow-lg cursor-pointer';
                deckCard.onclick = () => startFlashcards(index);
                deckCard.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-1">ğŸ´ ${deck.name}</h3>
                            <p class="text-sm text-gray-600">ã‚«ã‚¹ã‚¿ãƒ å˜èªå¸³</p>
                        </div>
                        <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-semibold">${deck.words.length}èª</span>
                    </div>
                    <div class="text-purple-600 font-semibold text-sm">ã‚«ãƒ¼ãƒ‰ã‚’é–‹ã â†’</div>
                `;
                deckListContainer.appendChild(deckCard);
            });
        }

        function startFlashcards(deckId) {
            currentFlashcardDeckId = deckId;
            const deck = customDecks[deckId];
            
            const savedVisibility = localStorage.getItem(`wordVisibility_${deckId}`);
            if (savedVisibility) {
                wordVisibility = JSON.parse(savedVisibility);
            } else {
                wordVisibility = {};
                deck.words.forEach((_, index) => {
                    wordVisibility[index] = true;
                });
            }

            updateFlashcardList();

            if (flashcardList.length === 0) {
                alert('è¡¨ç¤ºã™ã‚‹å˜èªãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¨­å®šã‹ã‚‰å˜èªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            currentFlashcardIndex = 0;

            document.getElementById('flashcard-menu-screen').classList.add('hidden');
            document.getElementById('flashcard-screen').classList.remove('hidden');
            
            showFlashcard();
        }

        function updateFlashcardList() {
            const deck = customDecks[currentFlashcardDeckId];
            flashcardList = deck.words
                .map((word, index) => ({ ...word, originalIndex: index }))
                .filter(word => wordVisibility[word.originalIndex]);
            flashcardList.sort(() => Math.random() - 0.5);
        }

        function showFlashcard() {
            if (flashcardList.length === 0) {
                document.getElementById('flashcard-english').textContent = 'å˜èªãªã—';
                document.getElementById('flashcard-japanese').textContent = 'å˜èªã‚’è¿½åŠ ã—ã¦ãã ã•ã„';
                document.getElementById('flashcard-progress').textContent = `0 / 0`;
                return;
            }

            const word = flashcardList[currentFlashcardIndex];
            document.getElementById('flashcard-english').textContent = word.english;
            document.getElementById('flashcard-japanese').textContent = word.japanese;
            document.getElementById('flashcard-progress').textContent = `${currentFlashcardIndex + 1} / ${flashcardList.length}`;
            
            document.getElementById('flashcard-inner').classList.remove('flipped');
        }

        function flipFlashcard() {
            if(flashcardList.length > 0) {
                document.getElementById('flashcard-inner').classList.toggle('flipped');
            }
        }

        function nextFlashcard() {
            if (flashcardList.length === 0) return;
            currentFlashcardIndex = (currentFlashcardIndex + 1) % flashcardList.length;
            showFlashcard();
        }

        function previousFlashcard() {
            if (flashcardList.length === 0) return;
            currentFlashcardIndex = (currentFlashcardIndex - 1 + flashcardList.length) % flashcardList.length;
            showFlashcard();
        }

        function backToFlashcardMenu() {
            document.getElementById('flashcard-screen').classList.add('hidden');
            document.getElementById('flashcard-menu-screen').classList.remove('hidden');
        }

        function openSideMenu() {
            document.getElementById('side-menu').classList.add('open');
            document.getElementById('side-menu-overlay').classList.add('open');
            renderWordSelectionList();
        }

        function closeSideMenu() {
            document.getElementById('side-menu').classList.remove('open');
            document.getElementById('side-menu-overlay').classList.remove('open');
        }

        function renderWordSelectionList() {
            const listContainer = document.getElementById('word-selection-list');
            const deck = customDecks[currentFlashcardDeckId];
            
            listContainer.innerHTML = '';
            deck.words.forEach((word, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors';
                div.innerHTML = `
                    <input type="checkbox" id="word-${index}" ${wordVisibility[index] ? 'checked' : ''} 
                           onchange="toggleWordVisibility(${index})" 
                           class="mr-3 w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500">
                    <label for="word-${index}" class="flex-1 cursor-pointer">
                        <span class="font-semibold text-gray-800">${word.english}</span>
                        <span class="text-gray-600 text-sm ml-2">- ${word.japanese}</span>
                    </label>
                `;
                listContainer.appendChild(div);
            });
        }

        function toggleWordVisibility(index) {
            const checkedCount = Object.values(wordVisibility).filter(v => v).length;
            if (checkedCount === 1 && wordVisibility[index]) {
                alert('å°‘ãªãã¨ã‚‚1ã¤ã®å˜èªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                document.getElementById(`word-${index}`).checked = true;
                return;
            }

            wordVisibility[index] = !wordVisibility[index];
            localStorage.setItem(`wordVisibility_${currentFlashcardDeckId}`, JSON.stringify(wordVisibility));
            
            updateFlashcardList();
            currentFlashcardIndex = 0;
            showFlashcard();
        }

        function speak(text) {
            if (!text || typeof speechSynthesis === 'undefined') return;
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; // Set language to English
            speechSynthesis.cancel(); // Cancel any previous speech
            speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>
